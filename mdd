#!/bin/bash
# mdd - MDD Script Wrapper (Bash + Zsh compatible)
# Usage: mdd <command> [args...]

# Color codes for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get script directory (bash + zsh compatible, handles symlinks)
if [[ -n "$ZSH_VERSION" ]]; then
    # Zsh - resolve symlink if needed
    SCRIPT_FILE="${(%):-%x}"
    # Resolve symlink to get actual file path
    if command -v readlink >/dev/null 2>&1; then
        # Try readlink -f first (GNU), fallback to readlink (BSD)
        RESOLVED=$(readlink -f "$SCRIPT_FILE" 2>/dev/null || readlink "$SCRIPT_FILE" 2>/dev/null || echo "$SCRIPT_FILE")
        if [ -n "$RESOLVED" ] && [ "$RESOLVED" != "$SCRIPT_FILE" ]; then
            SCRIPT_FILE="$RESOLVED"
        fi
    fi
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_FILE")" && pwd)"
elif [[ -n "$BASH_VERSION" ]]; then
    # Bash - resolve symlink if needed
    SCRIPT_FILE="${BASH_SOURCE[0]}"
    if command -v readlink >/dev/null 2>&1; then
        RESOLVED=$(readlink -f "$SCRIPT_FILE" 2>/dev/null || readlink "$SCRIPT_FILE" 2>/dev/null || echo "$SCRIPT_FILE")
        if [ -n "$RESOLVED" ] && [ "$RESOLVED" != "$SCRIPT_FILE" ]; then
            SCRIPT_FILE="$RESOLVED"
        fi
    fi
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_FILE")" && pwd)"
else
    # Fallback
    SCRIPT_FILE="$0"
    if command -v readlink >/dev/null 2>&1; then
        RESOLVED=$(readlink -f "$SCRIPT_FILE" 2>/dev/null || readlink "$SCRIPT_FILE" 2>/dev/null || echo "$SCRIPT_FILE")
        if [ -n "$RESOLVED" ] && [ "$RESOLVED" != "$SCRIPT_FILE" ]; then
            SCRIPT_FILE="$RESOLVED"
        fi
    fi
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_FILE")" && pwd)"
fi

# Try to find scripts directory
# Priority 1: Global MDD scripts (~/.mdd/scripts/)
# Priority 2: Project-local scripts (for backward compatibility)
GLOBAL_SCRIPTS_DIR="$HOME/.mdd/scripts"
PROJECT_SCRIPTS_DIR="$SCRIPT_DIR/scripts"

if [ -d "$GLOBAL_SCRIPTS_DIR" ]; then
    SCRIPTS_DIR="$GLOBAL_SCRIPTS_DIR"
elif [ -d "$PROJECT_SCRIPTS_DIR" ]; then
    # Fallback to project-local scripts (backward compatibility)
    SCRIPTS_DIR="$PROJECT_SCRIPTS_DIR"
else
    echo "❌ Error: MDD scripts directory not found"
    echo ""
    echo "Please install MDD scripts globally:"
    echo "  1. Clone MDD repository: git clone https://github.com/e-faraday/no_go_crayzy_anymore.git ~/.mdd"
    echo "  2. Or run setup.sh in your project to create .claude/ structure"
    echo ""
    echo "Global scripts location: $GLOBAL_SCRIPTS_DIR"
    echo "Project scripts location: $PROJECT_SCRIPTS_DIR"
    exit 1
fi

# Check version compatibility (skip for setup command and if override is set)
if [ "$1" != "setup" ] && [ -d ".claude" ] && [ "$MDD_SKIP_VERSION_CHECK" != "1" ]; then
    if [ -f "$SCRIPTS_DIR/check-mdd-version.sh" ]; then
        # Run version check script
        VERSION_CHECK_OUTPUT=$("$SCRIPTS_DIR/check-mdd-version.sh" 2>&1)
        VERSION_CHECK_EXIT=$?
        
        # Always show output
        echo "$VERSION_CHECK_OUTPUT" >&2
        
        # Exit 1 = Major version mismatch - BLOCKING (stop execution)
        if [ $VERSION_CHECK_EXIT -eq 1 ]; then
            echo "" >&2
            echo -e "${RED}❌ Command stopped: Major version incompatibility detected.${NC}" >&2
            echo -e "${YELLOW}Override: MDD_SKIP_VERSION_CHECK=1 mdd <command>${NC}" >&2
            exit 1
        fi
        # Exit 2 = Version file missing - Non-blocking (continue)
        # Exit 0 = Compatible - Continue normally
    fi
fi

get_script() {
    case "$1" in
        newtask|new-task) echo "new-task.sh" ;;
        checktask|check-task) echo "check-task.sh" ;;
        updateprogress|update-progress) echo "update-progress.sh" ;;
        starttask|start-task) echo "start-task.sh" ;;
        archivetask|archive|archive-completed) echo "archive-completed.sh" ;;
        autosync|auto-sync) echo "auto-sync.sh" ;;
        autocompletetask|autocomplete-task) echo "auto-complete-task.sh" ;;
        autocompletephases|autocomplete-phases) echo "auto-complete-phases.sh" ;;
        autoupdatestatus|autoupdate-status) echo "auto-update-status.sh" ;;
        autoupdatecheckpoint|autoupdate-checkpoint) echo "auto-update-checkpoint.sh" ;;
        autocommittask|autocommit-task) echo "auto-commit-task.sh" ;;
        autocommitplan|autocommit-plan) echo "auto-commit-plan.sh" ;;
        autocommitfeature|autocommit-feature) echo "auto-commit-feature.sh" ;;
        setpriority|set-priority) echo "set-priority.sh" ;;
        addtags|add-tags) echo "add-tags.sh" ;;
        dailysummary|daily-summary) echo "daily-summary.sh" ;;
        syncall|sync-all) echo "sync-all-tasks.sh" ;;
        setup) echo "setup.sh" ;;
        *) echo "" ;;
    esac
}

if [ $# -eq 0 ]; then
    echo "MDD - Markdown Driven Development"
    echo "Usage: mdd <command> [args...]"
    echo "Run 'mdd' without arguments to see all commands"
    exit 0
fi

CMD="$1"
shift
SCRIPT=$(get_script "$CMD")

if [ -z "$SCRIPT" ]; then
    echo "❌ Error: Unknown command '$CMD'"
    echo "Run 'mdd' without arguments to see available commands"
    exit 1
fi

SCRIPT_PATH="$SCRIPTS_DIR/$SCRIPT"
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "❌ Error: Script not found: $SCRIPT_PATH"
    exit 1
fi

[ ! -x "$SCRIPT_PATH" ] && chmod +x "$SCRIPT_PATH"
exec "$SCRIPT_PATH" "$@"
MDD_EOF
