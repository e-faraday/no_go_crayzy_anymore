#!/bin/bash
# mdd - MDD Script Wrapper (Bash + Zsh compatible)
# Usage: mdd <command> [args...]
#
# Provides short commands for MDD scripts
# Example: mdd autosync instead of ./scripts/auto-sync.sh

# Get script directory (bash + zsh compatible, handles symlinks)
if [[ -n "$ZSH_VERSION" ]]; then
    # Zsh - resolve symlink if needed
    SCRIPT_FILE="${(%):-%x}"
    # Resolve symlink to get actual file path
    if command -v readlink >/dev/null 2>&1; then
        # Try readlink -f first (GNU), fallback to readlink (BSD)
        RESOLVED=$(readlink -f "$SCRIPT_FILE" 2>/dev/null || readlink "$SCRIPT_FILE" 2>/dev/null || echo "$SCRIPT_FILE")
        if [ -n "$RESOLVED" ] && [ "$RESOLVED" != "$SCRIPT_FILE" ]; then
            SCRIPT_FILE="$RESOLVED"
        fi
    fi
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_FILE")" && pwd)"
elif [[ -n "$BASH_VERSION" ]]; then
    # Bash - resolve symlink if needed
    SCRIPT_FILE="${BASH_SOURCE[0]}"
    if command -v readlink >/dev/null 2>&1; then
        RESOLVED=$(readlink -f "$SCRIPT_FILE" 2>/dev/null || readlink "$SCRIPT_FILE" 2>/dev/null || echo "$SCRIPT_FILE")
        if [ -n "$RESOLVED" ] && [ "$RESOLVED" != "$SCRIPT_FILE" ]; then
            SCRIPT_FILE="$RESOLVED"
        fi
    fi
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_FILE")" && pwd)"
else
    # Fallback
    SCRIPT_FILE="$0"
    if command -v readlink >/dev/null 2>&1; then
        RESOLVED=$(readlink -f "$SCRIPT_FILE" 2>/dev/null || readlink "$SCRIPT_FILE" 2>/dev/null || echo "$SCRIPT_FILE")
        if [ -n "$RESOLVED" ] && [ "$RESOLVED" != "$SCRIPT_FILE" ]; then
            SCRIPT_FILE="$RESOLVED"
        fi
    fi
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_FILE")" && pwd)"
fi

# Try to find scripts directory
# Priority 1: Global MDD scripts (~/.mdd/scripts/)
# Priority 2: Project-local scripts (for backward compatibility)
GLOBAL_SCRIPTS_DIR="$HOME/.mdd/scripts"
PROJECT_SCRIPTS_DIR="$SCRIPT_DIR/scripts"

if [ -d "$GLOBAL_SCRIPTS_DIR" ]; then
    SCRIPTS_DIR="$GLOBAL_SCRIPTS_DIR"
elif [ -d "$PROJECT_SCRIPTS_DIR" ]; then
    # Fallback to project-local scripts (backward compatibility)
    SCRIPTS_DIR="$PROJECT_SCRIPTS_DIR"
else
    echo "❌ Error: MDD scripts directory not found"
    echo ""
    echo "Please install MDD scripts globally:"
    echo "  1. Clone MDD repository: git clone https://github.com/e-faraday/no_go_crayzy_anymore.git ~/.mdd"
    echo "  2. Or run setup.sh in your project to create .claude/ structure"
    echo ""
    echo "Global scripts location: $GLOBAL_SCRIPTS_DIR"
    echo "Project scripts location: $PROJECT_SCRIPTS_DIR"
    exit 1
fi

# Command mapping function (bash 3+ compatible)
get_script() {
    case "$1" in
        # Core workflow
        newtask|new-task) echo "new-task.sh" ;;
        checktask|check-task) echo "check-task.sh" ;;
        updateprogress|update-progress) echo "update-progress.sh" ;;
        starttask|start-task) echo "start-task.sh" ;;
        archivetask|archive|archive-completed) echo "archive-completed.sh" ;;
        # Automation
        autosync|auto-sync) echo "auto-sync.sh" ;;
        autocompletetask|autocomplete-task) echo "auto-complete-task.sh" ;;
        autocompletephases|autocomplete-phases) echo "auto-complete-phases.sh" ;;
        autoupdatestatus|autoupdate-status) echo "auto-update-status.sh" ;;
        autoupdatecheckpoint|autoupdate-checkpoint) echo "auto-update-checkpoint.sh" ;;
        # Git automation
        autocommittask|autocommit-task) echo "auto-commit-task.sh" ;;
        autocommitplan|autocommit-plan) echo "auto-commit-plan.sh" ;;
        autocommitfeature|autocommit-feature) echo "auto-commit-feature.sh" ;;
        # Utilities
        setpriority|set-priority) echo "set-priority.sh" ;;
        addtags|add-tags) echo "add-tags.sh" ;;
        dailysummary|daily-summary) echo "daily-summary.sh" ;;
        syncall|sync-all) echo "sync-all-tasks.sh" ;;
        setup) echo "setup.sh" ;;
        # Gold Standard - Validation & Hooks
        validatestate|validate-state) echo "validate-state.sh" ;;
        verifyenvparity|verify-env-parity) echo "verify-env-parity.sh" ;;
        detectaffectedtests|detect-affected-tests) echo "detect-affected-tests.sh" ;;
        installhooks|install-hooks|installprecommithook|install-pre-commit-hook) echo "install-pre-commit-hook.sh" ;;
        validatecommit|validate-commit|validatecommitmessage|validate-commit-message) echo "validate-commit-message.sh" ;;
        # Testing
        testactivemode|test-active-mode) echo "test-active-mode.sh" ;;
        e2etest|e2e-test) echo "e2e-test.sh" ;;
        *) echo "" ;;
    esac
}

# Show help if no command
if [ $# -eq 0 ]; then
    echo "MDD - Markdown Driven Development"
    echo ""
    echo "Usage: mdd <command> [args...]"
    echo ""
    echo "Core Commands:"
    echo "  newtask <type> <name>        Create new task (feature/bug/refactor/decision)"
    echo "  checktask <file> <task>      Check task checkbox"
    echo "  updateprogress <file> <msg>  Add progress entry"
    echo "  starttask <file> <msg>      Start task"
    echo "  archive                     Archive completed tasks"
    echo ""
    echo "Automation:"
    echo "  autosync                    Sync all tasks"
    echo "  autocompletetask <file>     Mark task as completed"
    echo "  autocompletephases <file>   Mark completed phases"
    echo "  autoupdatestatus <file>     Update status automatically"
    echo ""
    echo "Utilities:"
    echo "  setpriority <file> <priority>  Set priority (high/medium/low)"
    echo "  addtags <file> <tags...>      Add tags"
    echo "  dailysummary                 Show daily summary"
    echo "  syncall                      Sync all tasks"
    echo ""
    echo "Gold Standard (Validation & Hooks):"
    echo "  validatestate                Validate state is updated"
    echo "  verifyenvparity              Verify CI/test config parity"
    echo "  detectaffectedtests          Detect which tests are affected"
    echo "  installhooks                 Install git hooks"
    echo "  validatecommit <file>        Validate commit message format"
    echo ""
    echo "Testing:"
    echo "  testactivemode [--category] Run Active Mode tests"
    echo "  e2etest                     Run E2E test suite"
    echo ""
    echo "Examples:"
    echo "  mdd newtask feature \"Add dark mode\""
    echo "  mdd checktask .claude/active/feature-x.md \"Task 1\""
    echo "  mdd autosync"
    echo "  mdd archive"
    echo "  mdd validatestate"
    echo "  mdd installhooks"
    echo ""
    echo "Note: You can also use full script paths: ./scripts/new-task.sh"
    exit 0
fi

CMD="$1"
shift

# Get script name
SCRIPT=$(get_script "$CMD")

# Check if command exists
if [ -z "$SCRIPT" ]; then
    echo "❌ Error: Unknown command '$CMD'"
    echo ""
    echo "Run 'mdd' without arguments to see available commands"
    echo "Or use full script path: ./scripts/$CMD.sh"
    exit 1
fi

SCRIPT_PATH="$SCRIPTS_DIR/$SCRIPT"

# Check if script exists
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "❌ Error: Script not found: $SCRIPT_PATH"
    exit 1
fi

# Check if script is executable
if [ ! -x "$SCRIPT_PATH" ]; then
    echo "⚠️  Warning: Script not executable, making it executable..."
    chmod +x "$SCRIPT_PATH"
fi

# Execute script with remaining arguments
exec "$SCRIPT_PATH" "$@"
